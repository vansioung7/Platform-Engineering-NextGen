name: workload-drift-detection

on:
  schedule:
    - cron: "47 3 * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod
      chart_path:
        description: "Helm chart path"
        required: true
        default: "infra/workloads/chart"
        type: string
      namespace:
        description: "Kubernetes namespace for render context"
        required: true
        default: "default"
        type: string
      values_file:
        description: "Optional values file path"
        required: false
        default: ""
        type: string
      enable_argocd_check:
        description: "Enable Argo CD sync drift check"
        required: true
        default: true
        type: boolean
      argocd_app_name:
        description: "Argo CD application name"
        required: false
        default: ""
        type: string

permissions:
  contents: read
  issues: write

jobs:
  workload-drift:
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
      CHART_PATH: ${{ github.event.inputs.chart_path || vars.WORKLOAD_CHART_PATH || 'infra/workloads/chart' }}
      NAMESPACE: ${{ github.event.inputs.namespace || vars.WORKLOAD_NAMESPACE || 'default' }}
      VALUES_FILE: ${{ github.event.inputs.values_file || vars.WORKLOAD_VALUES_FILE || '' }}
      ENABLE_ARGOCD_CHECK: ${{ github.event.inputs.enable_argocd_check || vars.ENABLE_ARGOCD_CHECK || 'true' }}
      ARGOCD_APP_NAME: ${{ github.event.inputs.argocd_app_name || vars.ARGOCD_APP_NAME || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Setup Conftest
        uses: instrumenta/conftest-action@v1

      - name: Setup Argo CD CLI
        if: env.ENABLE_ARGOCD_CHECK == 'true'
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL -o /usr/local/bin/argocd "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64"
          chmod +x /usr/local/bin/argocd
          argocd version --client

      - name: Run Workload Drift Check
        id: workload_check
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ./scripts/workload-drift-check.sh
          ./scripts/workload-drift-check.sh
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}

      - name: Upload Workload Drift Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: workload-drift-${{ env.ENVIRONMENT }}
          path: .artifacts/

      - name: Create Workload Drift Issue
        if: steps.workload_check.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const envName = process.env.ENVIRONMENT;
            const app = process.env.ARGOCD_APP_NAME || "not-set";
            const today = new Date().toISOString().slice(0, 10);
            const title = `[workload-drift] Helm/Argo CD drift detected in ${envName} (${today})`;
            const body = [
              `Workload drift detected by workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              `Environment: ${envName}`,
              `Argo CD App: ${app}`,
              "",
              "Remediation checklist:",
              "1. Open PR with workload drift metadata (Drift Type: workload).",
              "2. Apply approved chart/value remediation through Git.",
              "3. Confirm Argo CD app is Synced and Healthy.",
              "4. Merge PR to close with audit."
            ].join("\n");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ["infra", "drift", "workload-drift"]
            });

