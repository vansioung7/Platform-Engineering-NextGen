name: drift-ticketing-and-notification

on:
  issues:
    types:
      - opened
      - labeled

permissions:
  contents: read
  issues: write

jobs:
  ticket-and-notify:
    if: contains(github.event.issue.labels.*.name, 'drift')
    runs-on: ubuntu-latest
    env:
      ENABLE_JIRA_INTEGRATION: ${{ vars.ENABLE_JIRA_INTEGRATION || 'false' }}
      ENABLE_DRIFT_NOTIFICATIONS: ${{ vars.ENABLE_DRIFT_NOTIFICATIONS || 'false' }}
      JIRA_PROJECT_KEY: ${{ vars.JIRA_PROJECT_KEY }}
      JIRA_ISSUE_TYPE: ${{ vars.JIRA_ISSUE_TYPE || 'Task' }}
    steps:
      - name: Create Jira Ticket
        id: jira_create
        if: env.ENABLE_JIRA_INTEGRATION == 'true'
        shell: bash
        run: |
          set -euo pipefail
          issue_title="${{ github.event.issue.title }}"
          issue_url="${{ github.event.issue.html_url }}"
          payload="$(jq -n \
            --arg project "${JIRA_PROJECT_KEY}" \
            --arg summary "[drift] ${issue_title}" \
            --arg description "Drift issue: ${issue_url}" \
            --arg issuetype "${JIRA_ISSUE_TYPE}" \
            '{fields:{project:{key:$project},summary:$summary,description:$description,issuetype:{name:$issuetype}}}')"

          response="$(curl -sS -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST \
            --data "${payload}" \
            "${JIRA_BASE_URL}/rest/api/3/issue")"

          jira_key="$(echo "${response}" | jq -r '.key // empty')"
          if [ -z "${jira_key}" ]; then
            echo "Failed to create Jira ticket. Response: ${response}" >&2
            exit 1
          fi
          echo "jira_key=${jira_key}" >> "${GITHUB_OUTPUT}"
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Comment Jira Link On Drift Issue
        if: steps.jira_create.outputs.jira_key != ''
        uses: actions/github-script@v7
        with:
          script: |
            const jiraBase = process.env.JIRA_BASE_URL;
            const jiraKey = process.env.JIRA_KEY;
            const issueNumber = context.payload.issue.number;
            const body = `Jira ticket created: ${jiraBase}/browse/${jiraKey}\n\nUse this key in remediation PR metadata.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body
            });
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_KEY: ${{ steps.jira_create.outputs.jira_key }}

      - name: Send Drift Notification
        if: env.ENABLE_DRIFT_NOTIFICATIONS == 'true'
        shell: bash
        run: |
          set -euo pipefail
          payload="$(jq -n \
            --arg title "${{ github.event.issue.title }}" \
            --arg url "${{ github.event.issue.html_url }}" \
            --arg repo "${{ github.repository }}" \
            --arg jira "${{ steps.jira_create.outputs.jira_key }}" \
            '{event:"drift_detected",repository:$repo,title:$title,url:$url,jira_key:$jira}')"
          curl -sS -X POST -H "Content-Type: application/json" --data "${payload}" "${DRIFT_NOTIFICATION_WEBHOOK_URL}"
        env:
          DRIFT_NOTIFICATION_WEBHOOK_URL: ${{ secrets.DRIFT_NOTIFICATION_WEBHOOK_URL }}

